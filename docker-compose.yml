version: '3.8'

services:
  vault:
    image: vault:1.13.3
    container_name: rag-vault
    ports: ["8200:8200"]
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "${VAULT_TOKEN:-root}"
      VAULT_ADDR: "http://0.0.0.0:8200"
    cap_add: ["IPC_LOCK"]
    networks: ["rag-network"]

  postgres:
    image: pgvector/pgvector:pg16
    container_name: rag-postgres
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-admin}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-devpassword}"
      POSTGRES_DB: "${POSTGRES_DB:-ragdb}"
    ports: ["5432:5432"]
    volumes: ["postgres_data:/var/lib/postgresql/data"]
    networks: ["rag-network"]

  mongo:
    image: mongo:6.0
    container_name: rag-mongo
    ports: ["27017:27017"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_USER:-admin}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_PASSWORD:-devpassword}"
    volumes: ["mongo_data:/data/db"]
    networks: ["rag-network"]

  backend:
    build: ./backend
    container_name: rag-backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./backend:/app
      - ./backend/media/pdfs:/app/pdfs
    ports:
      - "8000:8000"
    env_file:           
      - .env
    environment:
      - POSTGRES_HOST=postgres  # <--- THIS IS THE CRITICAL FIX
      - POSTGRES_PORT=5432
    depends_on:
      - postgres
      - mongo
    networks: ["rag-network"]

volumes:
  postgres_data:
  mongo_data:

networks:
  rag-network:
    driver: bridge