version: '3.8'

services:
  vault:
    image: vault:1.13.3
    container_name: rag-vault
    ports: ["8200:8200"]
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "${VAULT_TOKEN:-root}"
      VAULT_ADDR: "http://0.0.0.0:8200"
    cap_add: ["IPC_LOCK"]
    networks: ["rag-network"]

  postgres:
    image: pgvector/pgvector:pg16
    container_name: rag-postgres
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-admin}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-devpassword}"
      POSTGRES_DB: "${POSTGRES_DB:-ragdb}"
    ports: ["5434:5432"] # <--- CHANGED THIS TO 5433
    volumes: ["postgres_data:/var/lib/postgresql/data"]
    networks: ["rag-network"]

  mongo:
    image: mongo:6.0
    container_name: rag-mongo
    ports: ["27017:27017"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: "${MONGO_USER:-admin}"
      MONGO_INITDB_ROOT_PASSWORD: "${MONGO_PASSWORD:-devpassword}"
    volumes: ["mongo_data:/data/db"]
    networks: ["rag-network"]

  backend:
    build: ./backend
    container_name: rag-backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ./backend:/app
      - ./backend/media/pdfs:/app/pdfs
    ports:
      - "8000:8000"
    env_file:           
      - .env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    depends_on:
      - postgres
      - mongo
      - vault  # <--- ADDED THIS
    networks: ["rag-network"]

  # FIXED: Indentation aligned to the left
  prometheus:
    image: prom/prometheus:v2.45.0
    container_name: rag-prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - rag-network

  # FIXED: Indentation aligned to the left
  grafana:
    image: grafana/grafana:10.0.0
    container_name: rag-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - rag-network
    depends_on:
      - prometheus
      - mongo
      - vault

volumes:
  postgres_data:
  mongo_data:
  grafana_data: # FIXED: Added this missing volume

networks:
  rag-network:
    driver: bridge